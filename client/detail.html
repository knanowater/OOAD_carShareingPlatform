<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>DriveShare - 차량 상세정보</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="/scripts/script.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <style>
            .car-detail-hero {
                background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)),
                    url("https://images.unsplash.com/photo-1494972308805-46370c3ffe93?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1770&q=80");
                background-size: cover;
                background-position: center;
            }
            .image-gallery-thumbnail.active {
                border: 2px solid #3b82f6;
            }
            .sticky-booking {
                position: sticky;
                top: 100px;
            }
            .feature-icon {
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #3b82f6;
                color: white;
                border-radius: 50%;
            }
            .tab-button.active {
                border-bottom: 2px solid #3b82f6;
                color: #3b82f6;
                font-weight: 600;
            }
            .datepicker-input {
                background-color: #f9fafb;
            }
            .datepicker-container {
                position: relative;
            }
            .datepicker-container i {
                position: absolute;
                top: 50%;
                left: 12px;
                transform: translateY(-50%);
                color: #6b7280;
            }
            .datepicker-container input {
                padding-left: 36px;
            }
            .main-image-container {
                position: relative;
            }
            .nav-arrow {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                background-color: rgba(255, 255, 255, 0.8);
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 10;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
            }
            .nav-arrow:hover {
                background-color: rgba(255, 255, 255, 1);
                transform: translateY(-50%) scale(1.1);
            }
            .nav-arrow.left {
                left: 20px;
            }
            .nav-arrow.right {
                right: 20px;
            }
            .thumbnail-container {
                display: flex;
                overflow-x: auto;
                gap: 8px;
                padding: 8px 0;
                scrollbar-width: thin;
                scrollbar-color: #3b82f6 #f1f1f1;
            }
            .thumbnail-container::-webkit-scrollbar {
                height: 6px;
            }
            .thumbnail-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            .thumbnail-container::-webkit-scrollbar-thumb {
                background-color: #3b82f6;
                border-radius: 10px;
            }
            .thumbnail-item {
                flex: 0 0 auto;
                width: 160px;
                height: 120px;
                border-radius: 4px;
                overflow: hidden;
                cursor: pointer;
                border: 2px solid transparent;
                transition: all 0.2s ease;
            }
            .thumbnail-item:hover {
                border-color: #3b82f6;
                transform: scale(1.05);
            }
            .thumbnail-item.active {
                border-color: #3b82f6;
                border-width: 5px;
            }
            .thumbnail-img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
        </style>
    </head>
    <body class="font-sans antialiased text-gray-800 bg-gray-50">
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center" onclick="location.href='/'" style="cursor: pointer">
                    <i class="fas fa-car text-blue-600 text-3xl mr-2"></i>
                    <span class="text-2xl font-bold text-blue-600">DriveShare</span>
                </div>
                <nav class="hidden md:flex space-x-8">
                    <a href="/" class="text-gray-600 hover:text-blue-600">홈</a>
                    <a href="/list" class="text-blue-600 font-medium">차량 찾기</a>
                    <a href="#" class="text-gray-600 hover:text-blue-600">이용 방법</a>
                    <a href="#" class="text-gray-600 hover:text-blue-600">고객센터</a>
                    <a href="/mypage" class="text-gray-600 hover:text-blue-600">마이페이지</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <button class="px-4 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition">로그인 / 회원가입</button>
                    <button class="md:hidden text-gray-600">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            <section class="mb-12">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-2/3">
                        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-4 main-image-container">
                            <img id="main-image" alt="차량 메인 이미지" class="w-full h-96 object-cover" />

                            <div class="nav-arrow left" onclick="prevImage()">
                                <i class="fas fa-chevron-left text-gray-800"></i>
                            </div>

                            <div class="nav-arrow right" onclick="nextImage()">
                                <i class="fas fa-chevron-right text-gray-800"></i>
                            </div>
                        </div>

                        <div class="thumbnail-container" id="thumbnail-gallery"></div>
                    </div>

                    <div class="w-full md:w-1/3">
                        <div class="bg-white rounded-xl shadow-md p-6 sticky-booking">
                            <h1 class="text-2xl font-bold mb-2 car-full-name"></h1>
                            <div class="flex items-center mb-4">
                                <i class="fas fa-star text-yellow-400 mr-1"></i>
                                <span class="font-medium mr-2 car-rating"></span>
                            </div>

                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <p class="text-gray-500 text-sm">하루 기준</p>
                                    <p class="text-2xl font-bold text-blue-600" id="car-daily-rate"></p>
                                </div>
                            </div>

                            <div class="mb-6 border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <h3 class="font-medium text-gray-700 mb-3">예상 금액 계산</h3>

                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <label for="manual-total-days" class="text-sm text-gray-600 mr-2">총 대여일수:</label>
                                        <div class="flex items-center">
                                            <input
                                                type="number"
                                                id="manual-total-days"
                                                min="1"
                                                value="1"
                                                class="h-10 w-20 py-2 px-3 border border-gray-300 rounded-l-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800 font-medium"
                                            />
                                            <span
                                                id="total-days-unit"
                                                class="inline-flex items-center px-3 py-2 text-sm text-gray-800 bg-gray-200 border border-l-0 border-gray-300 rounded-r-lg font-medium h-10"
                                                >일</span
                                            >
                                        </div>
                                    </div>

                                    <div class="flex justify-between items-center border-t border-gray-200 pt-3">
                                        <span class="text-sm text-gray-600">서비스 수수료 (1일 요금의 10%):</span>
                                        <span id="service-fee" class="text-lg font-bold text-blue-600">0원</span>
                                    </div>

                                    <div class="flex justify-between items-center border-t border-gray-200 pt-3">
                                        <span class="text-sm text-gray-600">총 예상 금액 (수수료 포함):</span>
                                        <span id="total-price" class="text-lg font-bold text-blue-600">0원</span>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t border-b border-gray-100 py-4 mb-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-gray-500 text-sm">연료</p>
                                        <p class="font-medium car-fuel-type"></p>
                                    </div>
                                    <div>
                                        <p class="text-gray-500 text-sm">변속기</p>
                                        <p class="font-medium car-transmission"></p>
                                    </div>
                                    <div>
                                        <p class="text-gray-500 text-sm">연식</p>
                                        <p class="font-medium car-year"></p>
                                    </div>
                                    <div>
                                        <p class="text-gray-500 text-sm">인승</p>
                                        <p class="font-medium car-seat-num seat-num"></p>
                                    </div>
                                </div>
                            </div>

                            <button class="w-full py-3" id="reservation-button">예약하기</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 차량 상세정보 탭 -->
            <div id="details-tab" class="tab-content">
                <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <h2 class="text-xl font-bold mb-4">차량 사양</h2>
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <h3 class="font-medium text-gray-700 mb-2">기본 정보</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500">제조사</span>
                                    <span class="font-medium car-manufacturer"></span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500">모델</span>
                                    <span class="font-medium car-name"></span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500">연식</span>
                                    <span class="font-medium car-year">2022년</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500">차량 등급</span>
                                    <span class="font-medium" id="car-trim"></span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500">색상</span>
                                    <span class="font-medium" id="car-color"></span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500">연료</span>
                                    <span class="font-medium car-fuel-type"></span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500">변속기</span>
                                    <span class="font-medium car-transmission">자동</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500">인승</span>
                                    <span class="font-medium car-seat-num">5인승</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <section class="mb-12">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold mb-6">이용 안내 및 유의사항</h2>
                    <div class="space-y-4">
                        <div class="flex">
                            <div class="flex-shrink-0 text-blue-600 mr-3 mt-1">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div>
                                <h3 class="font-medium mb-1">대여 가능 연령</h3>
                                <p class="text-gray-600 text-sm">만 21세 이상, 운전 경력 1년 이상</p>
                            </div>
                        </div>
                        <div class="flex">
                            <div class="flex-shrink-0 text-blue-600 mr-3 mt-1">
                                <i class="fas fa-gas-pump"></i>
                            </div>
                            <div>
                                <h3 class="font-medium mb-1">연료 정책</h3>
                                <p class="text-gray-600 text-sm">대여 시 연료량과 동일하게 반납해 주세요. 차이가 있을 경우 추가 비용이 발생할 수 있습니다.</p>
                            </div>
                        </div>
                        <div class="flex">
                            <div class="flex-shrink-0 text-blue-600 mr-3 mt-1">
                                <i class="fas fa-smoking-ban"></i>
                            </div>
                            <div>
                                <h3 class="font-medium mb-1">금연 차량</h3>
                                <p class="text-gray-600 text-sm">본 차량은 금연 차량입니다. 차량 내 흡연 시 청소비가 추가로 부과됩니다.</p>
                            </div>
                        </div>
                        <div class="flex">
                            <div class="flex-shrink-0 text-blue-600 mr-3 mt-1">
                                <i class="fas fa-paw"></i>
                            </div>
                            <div>
                                <h3 class="font-medium mb-1">반려동물 동승</h3>
                                <p class="text-gray-600 text-sm">반려동물 동승이 가능하나, 차량 내부 오염 시 추가 청소비가 부과될 수 있습니다.</p>
                            </div>
                        </div>
                        <div class="flex">
                            <div class="flex-shrink-0 text-blue-600 mr-3 mt-1">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div>
                                <h3 class="font-medium mb-1">사고 및 고장 시</h3>
                                <p class="text-gray-600 text-sm">사고 또는 고장 발생 시 즉시 DriveShare 고객센터(1588-1234)로 연락주세요.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-gray-100 py-8 mt-12">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <div class="flex items-center mb-4">
                            <i class="fas fa-car text-blue-600 text-xl mr-2"></i>
                            <span class="text-lg font-bold text-gray-800">DriveShare</span>
                        </div>
                        <p class="text-gray-600 text-sm">DriveShare는 차량 공유 플랫폼으로 누구나 쉽게 차량을 대여하거나 호스트가 될 수 있습니다.</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 mb-4">회사</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">회사 소개</a></li>
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">채용 정보</a></li>
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">뉴스룸</a></li>
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">블로그</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 mb-4">지원</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm"> 도움말 센터</a></li>
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">안전 정보</a></li>
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">취소 옵션</a></li>
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">고객 지원</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 mb-4">약관</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">이용약관</a></li>
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">개인정보 처리방침</a></li>
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">쿠키 정책</a></li>
                            <li><a href="#" class="text-gray-600 hover:text-blue-600 text-sm">보험 정보</a></li>
                        </ul>
                    </div>
                </div>
                <div class="border-t border-gray-200 mt-8 pt-8 flex flex-col md:flex-row justify-between items-center">
                    <div class="text-gray-500 text-sm mb-4 md:mb-0">© 2023 DriveShare Inc. All rights reserved.</div>
                    <div class="flex space-x-6">
                        <a href="#" class="text-gray-500 hover:text-blue-600"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-gray-500 hover:text-blue-600"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-gray-500 hover:text-blue-600"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-gray-500 hover:text-blue-600"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
        </footer>

        <script>
            // 이미지 갤러리 관련 변수
            let currentImageIndex = 0;
            let imageUrls = [];
            // dailyRate 전역 변수 선언 및 초기화
            let dailyRate = 0;
            // 수수료 비율 (10%)
            const commissionRate = 0.1;

            // 이전 이미지 보기
            function prevImage() {
                if (imageUrls.length === 0) return;

                currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
                updateMainImage();
                updateActiveThumbnail();
            }

            // 다음 이미지 보기
            function nextImage() {
                if (imageUrls.length === 0) return;

                currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
                updateMainImage();
                updateActiveThumbnail();
            }

            // 메인 이미지 업데이트
            function updateMainImage() {
                const mainImage = document.getElementById("main-image");
                if (imageUrls.length > 0) {
                    mainImage.src = imageUrls[currentImageIndex];
                } else {
                    // 이미지가 없을 경우 기본 이미지 설정
                    mainImage.src = "https://placehold.co/600x400";
                }
            }

            // 활성 썸네일 업데이트
            function updateActiveThumbnail() {
                const thumbnails = document.querySelectorAll(".thumbnail-item");
                thumbnails.forEach((thumb, index) => {
                    if (index === currentImageIndex) {
                        thumb.classList.add("active");
                    } else {
                        thumb.classList.remove("active");
                    }
                });
                // 활성 썸네일이 스크롤 영역에 보이도록 스크롤 이동
                const activeThumbnail = document.querySelector(".thumbnail-item.active");
                if (activeThumbnail) {
                    activeThumbnail.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
                }
            }

            // 썸네일 클릭 시 메인 이미지 변경
            function changeMainImage(index) {
                currentImageIndex = index;
                updateMainImage();
                updateActiveThumbnail();
            }

            // 썸네일 갤러리 생성
            function createThumbnailGallery() {
                const galleryContainer = document.getElementById("thumbnail-gallery");
                galleryContainer.innerHTML = ""; // 기존 썸네일 비우기

                if (imageUrls.length === 0) {
                    // 이미지가 없는 경우 기본 이미지 추가
                    const defaultImage = "https://placehold.co/600x400";
                    // imageUrls 배열 자체는 비워두고 기본 이미지만 표시
                    const thumbnailItem = document.createElement("div");
                    thumbnailItem.className = "thumbnail-item active";
                    // 기본 이미지는 클릭해도 다른 이미지로 변경되지 않으므로 onclick 제거
                    // thumbnailItem.onclick = () => changeMainImage(0);

                    const thumbnailImg = document.createElement("img");
                    thumbnailImg.className = "thumbnail-img";
                    thumbnailImg.src = defaultImage;
                    thumbnailImg.alt = "차량 이미지 없음";

                    thumbnailItem.appendChild(thumbnailImg);
                    galleryContainer.appendChild(thumbnailItem);
                } else {
                    // 이미지가 있는 경우 모든 이미지에 대한 썸네일 생성
                    imageUrls.forEach((url, index) => {
                        const thumbnailItem = document.createElement("div");
                        thumbnailItem.className = `thumbnail-item ${index === 0 ? "active" : ""}`;
                        thumbnailItem.onclick = () => changeMainImage(index);

                        const thumbnailImg = document.createElement("img");
                        thumbnailImg.className = "thumbnail-img";
                        thumbnailImg.src = url;
                        thumbnailImg.alt = `차량 이미지 ${index + 1}`;

                        // 이미지 로드 실패 시 대체 이미지 표시
                        thumbnailImg.onerror = function () {
                            this.onerror = null; // 무한 루프 방지
                            this.src = "https://placehold.co/160x120?text=Image+Error"; // 대체 이미지
                            this.alt = "이미지 로드 실패";
                        };

                        thumbnailItem.appendChild(thumbnailImg);
                        galleryContainer.appendChild(thumbnailItem);
                    });
                }
                // 갤러리 생성 후 첫 번째 이미지를 메인으로 설정 및 썸네일 활성화
                currentImageIndex = 0;
                updateMainImage();
                updateActiveThumbnail();
            }

            // 날짜 차이 계산 함수 (일 단위) - 더 이상 사용되지 않음
            // function calculateDateDifference(startDate, endDate) { ... }

            // 날짜 유효성 검사 및 총 금액 계산 (수동 일수 입력 기반)
            function updateBookingDetails() {
                const manualDaysInput = document.getElementById("manual-total-days");
                // const totalDaysElement = document.getElementById("total-days"); // 이 줄은 이제 필요 없습니다.
                const serviceFeeElement = document.getElementById("service-fee");
                const totalPriceElement = document.getElementById("total-price");
                const reservationButton = document.getElementById("reservation-button");

                const days = parseInt(manualDaysInput.value, 10); // 입력된 일수를 정수로 파싱

                // 일수 유효성 검사 (1 이상인지 확인)
                if (!isNaN(days) && days >= 1) {
                    // 총 대여일수 스팬 업데이트 (이 부분은 이제 HTML input 필드 옆의 '일' 단위 스팬이 담당합니다)
                    // totalDaysElement.textContent = `${days}일`; // 이 줄은 삭제합니다.

                    // 전역 dailyRate 변수 사용
                    const currentDailyRate = window.dailyRate || 0; // dailyRate가 설정되지 않았으면 0 사용

                    // 수수료 계산 (1일 요금의 10%)
                    const dailyCommission = currentDailyRate * commissionRate;
                    serviceFeeElement.textContent = `${dailyCommission.toLocaleString()}원`; // 1일 기준 수수료 표시

                    // 총 대여 금액 (수수료 제외)
                    const basePrice = days * currentDailyRate;
                    // 총 수수료
                    const totalCommission = days * dailyCommission;
                    // 최종 총 금액 (기본 금액 + 총 수수료)
                    const totalPrice = basePrice + totalCommission;

                    totalPriceElement.textContent = `${totalPrice.toLocaleString()}원`;

                    // 예약 버튼 활성화 (차량 상태가 Available이고 일수가 유효할 때)
                    if (window.isCarAvailable === true) {
                        // 차량 상태 확인을 위한 전역 변수 사용
                        reservationButton.disabled = false;
                        reservationButton.classList.remove("bg-gray-400", "cursor-not-allowed");
                        reservationButton.classList.add("bg-blue-600", "hover:bg-blue-700", "text-white");
                    } else {
                        // 차량 상태가 Available이 아니면 비활성화
                        reservationButton.disabled = true;
                        reservationButton.classList.add("w-full", "py-3", "bg-gray-400", "text-white", "font-medium", "rounded-lg", "transition", "mb-3", "cursor-not-allowed");
                        reservationButton.innerHTML = "예약 불가";
                    }
                } else {
                    // 일수가 유효하지 않은 경우 (입력 필드가 비어있거나 1 미만)
                    // totalDaysElement.textContent = "1일"; // 이 줄도 삭제합니다.
                    serviceFeeElement.textContent = "0원";
                    totalPriceElement.textContent = "0원";
                    // 예약 버튼 비활성화
                    reservationButton.disabled = true;
                    reservationButton.classList.add("bg-gray-400", "cursor-not-allowed");
                    reservationButton.classList.remove("bg-blue-600", "hover:bg-blue-700", "text-white");
                }
            }

            window.addEventListener("DOMContentLoaded", function () {
                //차량 정보 로드
                {
                    const urlParams = new URLSearchParams(window.location.search);
                    const carId = urlParams.get("id");

                    // 차량 가용 상태를 저장할 전역 변수
                    window.isCarAvailable = false;

                    if (carId) {
                        fetch(`/api/cars/${carId}`)
                            .then((response) => {
                                if (!response.ok) {
                                    console.error(`HTTP error! status: ${response.status}`);
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then((car) => {
                                const getSafeValue = (value, suffix = "", isNumber = false) => {
                                    if (value === null || value === undefined || value === "None") {
                                        return "알 수 없음";
                                    }
                                    return isNumber ? `${parseFloat(value)}${suffix}` : `${value}${suffix}`;
                                };

                                Array.from(document.getElementsByClassName("car-manufacturer")).forEach((el) => {
                                    el.innerHTML = getSafeValue(car.manufacturer);
                                });

                                Array.from(document.getElementsByClassName("car-name")).forEach((el) => {
                                    el.innerHTML = getSafeValue(car.name);
                                });

                                Array.from(document.getElementsByClassName("car-year")).forEach((el) => {
                                    el.innerHTML = getSafeValue(car.year, "년");
                                });

                                Array.from(document.getElementsByClassName("car-full-name")).forEach((el) => {
                                    const year = getSafeValue(car.year);
                                    const manufacturer = getSafeValue(car.manufacturer);
                                    const name = getSafeValue(car.name);
                                    el.innerHTML = `${year} ${manufacturer} ${name}`;
                                });

                                Array.from(document.getElementsByClassName("car-fuel-type")).forEach((el) => {
                                    el.innerHTML = getSafeValue(car.fuel_type);
                                });

                                Array.from(document.getElementsByClassName("car-transmission")).forEach((el) => {
                                    el.innerHTML = getSafeValue(car.transmission);
                                });

                                Array.from(document.getElementsByClassName("car-seat-num")).forEach((el) => {
                                    el.innerHTML = getSafeValue(car.seat_num, "인승");
                                });

                                Array.from(document.getElementsByClassName("car-rating")).forEach((el) => {
                                    const rating = parseFloat(car.rating);
                                    el.innerHTML = isNaN(rating) ? "평가 없음" : `${rating.toFixed(1)}`;
                                });

                                window.dailyRate = typeof car.daily_rate === "number" ? car.daily_rate : 0;

                                if (Array.isArray(car.image_url)) {
                                    imageUrls = car.image_url;
                                } else if (typeof car.image_url === "string" && car.image_url) {
                                    imageUrls = [car.image_url];
                                } else {
                                    imageUrls = [];
                                }

                                createThumbnailGallery();

                                document.querySelector("#car-daily-rate").innerHTML = `${window.dailyRate.toLocaleString()}원`;
                                document.querySelector("#service-fee").innerHTML = `${(window.dailyRate * 0.1).toLocaleString()}원`;
                                document.querySelector("#car-trim").innerHTML = getSafeValue(car.car_trim);
                                document.querySelector("#car-color").innerHTML = getSafeValue(car.color);

                                const reservationBtn = document.querySelector("#reservation-button");
                                reservationBtn.classList.remove("bg-blue-600", "hover:bg-blue-700", "text-white", "bg-gray-400", "cursor-not-allowed");
                                reservationBtn.removeEventListener("click", handleReservationClick);

                                if (car.status === "Available") {
                                    window.isCarAvailable = true; // 차량 상태를 전역 변수에 저장
                                    reservationBtn.classList.add("bg-blue-600", "hover:bg-blue-700", "text-white", "font-medium", "rounded-lg", "transition", "mb-3");
                                    reservationBtn.addEventListener("click", handleReservationClick);
                                    reservationBtn.innerHTML = "예약하기";
                                } else {
                                    window.isCarAvailable = false; // 차량 상태를 전역 변수에 저장
                                    reservationBtn.disabled = true;
                                    reservationBtn.classList.add("w-full", "py-3", "bg-gray-400", "text-white", "font-medium", "rounded-lg", "transition", "mb-3", "cursor-not-allowed");
                                    reservationBtn.innerHTML = "예약 불가";
                                }

                                // 수동 일수 입력 필드 이벤트 리스너 추가
                                const manualDaysInput = document.getElementById("manual-total-days");
                                manualDaysInput.addEventListener("input", updateBookingDetails);
                                manualDaysInput.addEventListener("change", updateBookingDetails); // change 이벤트도 추가하여 숫자 위/아래 버튼 클릭 시에도 반응하도록

                                // 초기 금액 계산을 위해 updateBookingDetails 호출
                                updateBookingDetails();
                            })
                            .catch((error) => {
                                console.error("차량 정보 로딩 실패: ", error);
                                window.dailyRate = 0;
                                window.isCarAvailable = false; // 에러 시 가용 상태 false
                                document.querySelector("#car-daily-rate").innerHTML = `0원`;

                                // 수동 일수 입력 필드 이벤트 리스너 추가 (에러 시에도 필요)
                                const manualDaysInput = document.getElementById("manual-total-days");
                                manualDaysInput.addEventListener("input", updateBookingDetails);
                                manualDaysInput.addEventListener("change", updateBookingDetails);

                                updateBookingDetails();
                            });
                    } else {
                        console.error("차량 ID가 URL에 없습니다.");
                        window.dailyRate = 0;
                        window.isCarAvailable = false; // ID 없으면 가용 상태 false
                        document.querySelector("#car-daily-rate").innerHTML = `0원`;

                        // 수동 일수 입력 필드 이벤트 리스너 추가 (ID 없을 때도 필요)
                        const manualDaysInput = document.getElementById("manual-total-days");
                        manualDaysInput.addEventListener("input", updateBookingDetails);
                        manualDaysInput.addEventListener("change", updateBookingDetails);

                        updateBookingDetails();
                    }
                }
            });

            // 예약 버튼 클릭 핸들러 함수 (중복 추가 방지를 위해 분리)
            function handleReservationClick() {
                const urlParams = new URLSearchParams(window.location.search);
                const carId = urlParams.get("id");

                if (carId) {
                    location.href = `/reservation?id=${carId}`;
                } else {
                    console.error("차량 ID가 없어 예약 페이지로 이동할 수 없습니다.");
                }
            }
        </script>
    </body>
</html>
