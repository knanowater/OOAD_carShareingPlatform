<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>DriveShare - 예약 내역</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <style>
            .filter-active {
                background-color: #3b82f6;
                color: white;
            }
            .reservation-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .status-badge {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: 9999px;
            }
            .pagination-active {
                background-color: #3b82f6;
                color: white;
            }
        </style>
    </head>
    <body class="font-sans antialiased text-gray-800 bg-gray-50">
        <!-- 헤더 영역 -->
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center" onclick="location.href='/'" style="cursor: pointer">
                    <i class="fas fa-car text-blue-600 text-3xl mr-2"></i>
                    <span class="text-2xl font-bold text-blue-600">DriveShare</span>
                </div>
                <nav class="hidden md:flex space-x-8">
                    <a href="/" class="text-gray-600 hover:text-blue-600">홈</a>
                    <a href="/list" class="text-gray-600 hover:text-blue-600">차량 찾기</a>
                    <a href="#" class="text-gray-600 hover:text-blue-600">이용 방법</a>
                    <a href="#" class="text-gray-600 hover:text-blue-600">고객센터</a>
                    <a href="/mypage" class="text-blue-600 font-medium">마이페이지</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <button class="px-4 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition" onclick="location.href='/logout'">로그아웃</button>
                    <button class="md:hidden text-gray-600">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 메인 컨텐츠 영역 -->
        <main class="container mx-auto px-4 py-8">
            <!-- 페이지 헤더 -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold mb-2">예약 내역</h1>
                    <p class="text-gray-600">지난 1년간의 예약 내역을 확인할 수 있습니다.</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <button onclick="window.print()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition"><i class="fas fa-print mr-2"></i>인쇄하기</button>
                </div>
            </div>

            <!-- 필터 섹션 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h2 class="text-lg font-bold mb-4 md:mb-0">예약 상태 필터</h2>
                    <div class="flex flex-wrap gap-2">
                        <button class="filter-active px-4 py-2 rounded-full text-sm transition" onclick="filterReservations('all')">전체 보기</button>
                        <button class="bg-gray-100 px-4 py-2 rounded-full text-sm hover:bg-gray-200 transition" onclick="filterReservations('upcoming')">이용 예정</button>
                        <button class="bg-gray-100 px-4 py-2 rounded-full text-sm hover:bg-gray-200 transition" onclick="filterReservations('completed')">이용 완료</button>
                        <button class="bg-gray-100 px-4 py-2 rounded-full text-sm hover:bg-gray-200 transition" onclick="filterReservations('canceled')">취소된 예약</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">시작일</label>
                        <input type="date" id="start-date" class="w-full p-2 border border-gray-300 rounded" />
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">종료일</label>
                        <input type="date" id="end-date" class="w-full p-2 border border-gray-300 rounded" />
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <label for="car-type" class="block text-sm font-medium text-gray-700 mb-1">차종</label>
                        <select id="car-type" class="w-full p-2 border border-gray-300 rounded">
                            <option value="">전체</option>
                            <option value="sedan">세단</option>
                            <option value="suv">SUV</option>
                            <option value="electric">전기차</option>
                            <option value="premium">프리미엄</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">검색하기</button>
                    </div>
                </div>
            </div>

            <!-- 예약 목록 -->
            <div id="reservations-list">
                <!-- 테이블 헤더 (모바일에서는 숨김) -->
                <div class="hidden md:grid grid-cols-12 bg-gray-100 p-4 font-medium text-gray-700">
                    <div class="col-span-3">차량 정보</div>
                    <div class="col-span-2">예약일</div>
                    <div class="col-span-2">이용일</div>
                    <div class="col-span-2">결제 금액</div>
                    <div class="col-span-2">상태</div>
                    <div class="col-span-1">관리</div>
                </div>
            </div>

            <!-- 페이지네이션 -->
            <div class="flex justify-center">
                <nav class="inline-flex rounded-md shadow">
                    <a href="#" class="px-3 py-2 rounded-l-md border border-gray-300 bg-white text-gray-500 hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <a href="#" class="px-4 py-2 border-t border-b border-gray-300 bg-white text-gray-500 hover:bg-gray-50 pagination-active"> 1 </a>
                    <a href="#" class="px-4 py-2 border-t border-b border-gray-300 bg-white text-gray-500 hover:bg-gray-50"> 2 </a>
                    <a href="#" class="px-4 py-2 border-t border-b border-gray-300 bg-white text-gray-500 hover:bg-gray-50"> 3 </a>
                    <a href="#" class="px-3 py-2 rounded-r-md border border-gray-300 bg-white text-gray-500 hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </nav>
            </div>
        </main>

        <!-- 푸터 영역 -->
        <footer class="bg-gray-900 text-white py-12">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <div class="flex items-center mb-4">
                            <i class="fas fa-car text-blue-400 text-2xl mr-2"></i>
                            <span class="text-xl font-bold">DriveShare</span>
                        </div>
                        <p class="text-gray-400 mb-4">국내 최고의 카셰어링 플랫폼</p>
                        <div class="flex space-x-4">
                            <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-instagram"></i></a>
                            <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-4">이용안내</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-gray-400 hover:text-white">이용 방법</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white">요금 안내</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white">보험 안내</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white">자주 묻는 질문</a></li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-4">호스트 안내</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-gray-400 hover:text-white">호스트 가이드</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white">호스트 등록하기</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white">수익 계산기</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white">호스트 지원</a></li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-4">고객센터</h3>
                        <ul class="space-y-2">
                            <li class="text-gray-400">평일 09:00 ~ 18:00</li>
                            <li class="text-gray-400">(점심시간 12:00 ~ 13:00)</li>
                            <li class="mt-4"><a href="tel:1670-1234" class="text-blue-400 hover:text-blue-300">1670-1234</a></li>
                            <li><a href="mailto:help@driveshare.co.kr" class="text-blue-400 hover:text-blue-300">help@driveshare.co.kr</a></li>
                        </ul>
                    </div>
                </div>

                <div class="border-t border-gray-800 mt-12 pt-8 flex flex-col md:flex-row justify-between items-center">
                    <div class="text-gray-500 text-sm mb-4 md:mb-0">© 2023 DriveShare Inc. All rights reserved.</div>
                    <div class="flex space-x-6">
                        <a href="#" class="text-gray-500 hover:text-white text-sm">이용약관</a>
                        <a href="#" class="text-gray-500 hover:text-white text-sm">개인정보처리방침</a>
                        <a href="#" class="text-gray-500 hover:text-white text-sm">위치기반서비스 이용약관</a>
                    </div>
                </div>
            </div>
        </footer>

        <script>
            // 드롭다운 메뉴 토글 기능
            document.addEventListener("DOMContentLoaded", function () {
                const dropdownButtons = document.querySelectorAll(".dropdown button");

                dropdownButtons.forEach((button) => {
                    button.addEventListener("click", function (e) {
                        e.stopPropagation();
                        const menu = this.nextElementSibling;
                        const isHidden = menu.classList.contains("hidden");

                        // 다른 모든 드롭다운 메뉴 닫기
                        document.querySelectorAll(".dropdown-menu").forEach((m) => {
                            if (m !== menu) m.classList.add("hidden");
                        });

                        // 현재 메뉴 토글
                        if (isHidden) {
                            menu.classList.remove("hidden");
                        } else {
                            menu.classList.add("hidden");
                        }
                    });
                });

                // 문서 클릭 시 드롭다운 메뉴 닫기
                document.addEventListener("click", function () {
                    document.querySelectorAll(".dropdown-menu").forEach((menu) => {
                        menu.classList.add("hidden");
                    });
                });

                // 필터 버튼 기능
                const filterButtons = document.querySelectorAll('[onclick^="filterReservations"]');

                filterButtons.forEach((button) => {
                    button.addEventListener("click", function () {
                        // 모든 필터 버튼에서 active 클래스 제거
                        filterButtons.forEach((btn) => {
                            btn.classList.remove("filter-active");
                            btn.classList.add("bg-gray-100");
                        });

                        // 클릭한 버튼에 active 클래스 추가
                        this.classList.add("filter-active");
                        this.classList.remove("bg-gray-100");

                        // 여기에 실제 필터링 로직을 구현할 수 있습니다.
                        const filterType = this.getAttribute("onclick").replace("filterReservations('", "").replace("')", "");
                        console.log(`Filtering by: ${filterType}`);
                    });
                });
            });
            async function fetchReservations() {
                const token = localStorage.getItem("token");

                if (!token) {
                    console.error("인증 토큰이 없습니다.");
                    window.location.href = "/login";
                    return;
                }

                try {
                    const response = await fetch("/api/reservations", {
                        method: "GET",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                        },
                    });

                    if (response.ok) {
                        const reservations = await response.json();
                        console.log(reservations);
                        renderReservations(reservations);
                    } else {
                        console.error("예약 내역 로드 실패:", response.status);
                        // 오류 처리
                    }
                } catch (error) {
                    console.error("예약 내역 요청 중 오류 발생:", error);
                    // 오류 처리
                }
            }

            function renderReservations(reservations) {
                const reservationsListContainer = document.getElementById("reservations-list");

                if (!reservationsListContainer) {
                    console.error("예약 목록을 표시할 컨테이너 요소를 찾을 수 없습니다.");
                    return;
                }

                reservationsListContainer.innerHTML = "";

                if (!reservations || reservations.length === 0) {
                    reservationsListContainer.innerHTML = "<p>예약 내역이 없습니다.</p>";
                    return;
                }

                reservations.forEach((reservation) => {
                    const reservationCard = document.createElement("div");
                    reservationCard.classList.add("bg-white", "rounded-xl", "shadow-md", "p-6", "mb-4");

                    const carImageUrl = reservation.car_image_url || "https://placehold.co/200x150";
                    const carManufature = reservation.car_manufacture;
                    const carModel = reservation.car_model || "차량 모델 정보 없음";
                    const rentalDate = formatDate(reservation.rental_date);
                    const returnDate = formatDate(reservation.return_date);
                    const rentalPeriodDays = reservation.rental_period_days || "정보 없음";
                    const totalPrice = formatPrice(reservation.total_price);
                    const pickupLocation = reservation.pickup_location || "픽업 장소 정보 없음";

                    reservationCard.innerHTML = `
              <div class="flex flex-col md:flex-row md:items-center">
                <img
                  src="${carImageUrl}"
                  alt="${carModel}"
                  class="w-full md:w-48 h-32 object-cover rounded-lg mb-3 md:mb-0 md:mr-6"
                />
                <div class="flex-1">
                  <div class="flex justify-between items-start">
                    <div>
                      <h3 class="font-bold text-lg">${carManufature} ${carModel}</h3>
                    </div>
                    <span class="${getReservationStatusClass(reservation.reservation_status)} text-xs px-2 py-1 rounded">${getReservationStatusText(reservation.reservation_status)}</span>
                  </div>
                  <div class="mt-2 text-sm">
                    <p class="text-gray-600"><i class="fas fa-calendar-alt text-blue-500 mr-2"></i>${rentalDate} ~ ${returnDate}</p>
                    <p class="text-gray-600"><i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>${pickupLocation}</p>
                  </div>
                </div>
                <div class="mt-3 md:mt-0 md:ml-4 text-right">
                  <p class="font-bold text-lg">${totalPrice}원</p>
                  ${getReservationActionButton(reservation)}
                </div>
              </div>
            `;

                    reservationsListContainer.appendChild(reservationCard);
                });
            }

            function formatDate(dateString) {
                try {
                    const date = new Date(dateString);
                    return `${date.getFullYear()}.${(date.getMonth() + 1).toString().padStart(2, "0")}.${date.getDate().toString().padStart(2, "0")}`;
                } catch (error) {
                    console.error("날짜 포맷 오류:", dateString, error);
                    return "날짜 정보 없음";
                }
            }

            function formatPrice(price) {
                return price.toLocaleString();
            }

            function getReservationStatusText(status) {
                switch (status.toLowerCase()) {
                    case "pending":
                        return "호스트 수락 대기중";
                    case "scheduled":
                        return "이용 대기중";
                    case "in use":
                        return "이용 중";
                    case "completed":
                        return "이용 완료";
                    case "canceled":
                        return "취소됨";
                    default:
                        return status;
                }
            }

            function getReservationStatusClass(status) {
                switch (status.toLowerCase()) {
                    case "pending": // 호스트 수락 대기중
                        return "bg-gray-100 text-gray-600";
                    case "scheduled": // 이용 예정
                        return "bg-blue-100 text-blue-700";
                    case "in use": // 이용 중
                        return "bg-yellow-100 text-yellow-800";
                    case "completed": // 이용 완료
                        return "bg-green-100 text-green-700";
                    case "canceled": // 취소됨
                        return "bg-red-100 text-red-700";
                    default:
                        return "bg-gray-100 text-gray-800";
                }
            }

            function getReservationActionButton(reservation) {
                if (reservation.reservation_status.toLowerCase() === "pending") {
                    return `<button class="mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600" onclick="cancelButton(${reservation.reservation_id})" >취소</button> <button class="mt-2 ml-2 px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">상세 보기</button>`;
                } else if (reservation.reservation_status.toLowerCase() === "in use") {
                    return `<button class="mt-2 px-3 py-1 bg-amber-500 text-white text-sm rounded hover:bg-amber-600" onclick="returnButton(${reservation.reservation_id})">반납 하기</button> <button class="mt-2 ml-2 px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">상세 보기</button>`;
                } else if (reservation.reservation_status.toLowerCase() === "completed") {
                    return '<button class="mt-2 px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">리뷰 작성</button>';
                }
                return '<button class="mt-2 px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300">상세 보기</button>';
            }

            async function cancelButton(reservationId) {
                if (confirm("예약을 취소하시겠습니까?")) {
                    const token = localStorage.getItem("token");

                    if (!token) {
                        window.location.href = "/login";
                        return;
                    }

                    try {
                        const response = await fetch("/api/cancel", {
                            method: "POST",
                            headers: {
                                Authorization: `Bearer ${token}`,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ reservation_id: reservationId }),
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert(result.message || "예약이 취소되었습니다.");
                            window.location.reload();
                        } else {
                            const errorResult = await response.json();
                            console.error("예약 취소 실패:", response.status, errorResult);
                            alert(errorResult.message || "예약 취소에 실패했습니다.");
                        }
                    } catch (error) {
                        console.error("예약 취소 요청 중 오류 발생:", error);
                        alert("예약 취소 요청 중 오류가 발생했습니다.");
                    }
                }
            }

            async function returnButton(reservationId) {
                if (confirm("차량을 반납하시겠습니까?")) {
                    const token = localStorage.getItem("token");

                    if (!token) {
                        window.location.href = "/login";
                        return;
                    }

                    try {
                        const response = await fetch("/api/return", {
                            method: "POST",
                            headers: {
                                Authorization: `Bearer ${token}`,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ reservation_id: reservationId }), // <-- 키 이름을 소문자로 변경
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert(result.message || "차량 반납이 완료되었습니다.");
                            window.location.reload();
                        } else {
                            const errorResult = await response.json();
                            console.error("차량 반납 실패:", response.status, errorResult);
                            alert(errorResult.message || "차량 반납에 실패했습니다.");
                        }
                    } catch (error) {
                        console.error("차량 반납 요청 중 오류 발생:", error);
                        alert("차량 반납 요청 중 오류가 발생했습니다.");
                    }
                }
            }

            window.addEventListener("DOMContentLoaded", function () {
                fetchReservations();
            });
        </script>
    </body>
</html>
